- [锁频环锁相环共同点](#锁频环锁相环共同点)
  - [1. FLL 依赖于鉴相器（PD）的输出](#1-fll-依赖于鉴相器pd的输出)
  - [2. 为什么 FLL 依然是“频率”环路？](#2-为什么-fll-依然是频率环路)
- [锁相环（PLL）的工程实现细节](#锁相环pll的工程实现细节)
  - [1. 鉴相鉴频器（PFD）和电荷泵（CP）](#1-鉴相鉴频器pfd和电荷泵cp)
  - [2. 环路滤波器（Loop Filter, LF）](#2-环路滤波器loop-filter-lf)
  - [3. 压控振荡器（VCO）](#3-压控振荡器vco)
  - [4. 反馈分频器（Frequency Divider）](#4-反馈分频器frequency-divider)
- [锁频环（FLL）的工程实现细节](#锁频环fll的工程实现细节)
  - [1. 鉴频器（Frequency Error Detector, FED）](#1-鉴频器frequency-error-detector-fed)
    - [鉴频器工作机理总结](#鉴频器工作机理总结)
      - [核心原理：频率是相位的微分](#核心原理频率是相位的微分)
      - [鉴频器的三个关键步骤（以二象限反正切法为例）](#鉴频器的三个关键步骤以二象限反正切法为例)
      - [简化总结](#简化总结)
  - [2. 数字环路滤波器（Digital Loop Filter, DLF）](#2-数字环路滤波器digital-loop-filter-dlf)
  - [3. 数字压控振荡器（Numerically Controlled Oscillator, NCO）](#3-数字压控振荡器numerically-controlled-oscillator-nco)
- [FLL 和 PLL 的联合工程（F-PLL）](#fll-和-pll-的联合工程f-pll)




## 锁频环锁相环共同点

这是一个非常深刻的见解，它指向了 FLL 和 PLL 在硬件和软件实现上的**共用部件**。

您的推论是正确的：FLL 确实在环路内部包含了鉴相功能，或者说，它依赖于鉴相器的输出信息。

---

### 1. FLL 依赖于鉴相器（PD）的输出

FLL 的核心算法，即您提到的：

$$\text{频率误差} \propto \frac{\Delta\theta[n] - \Delta\theta[n-1]}{T_{coh}}$$

这里的 $\Delta\theta[n]$ 是第 $n$ 个相干积分周期结束时的**瞬时相位误差**。这个相位误差 $\Delta\theta[n]$ 正是**由鉴相器（Phase Detector, PD）的功能提供的**。

在 GNSS 接收机或数字同步系统中，鉴相器（PD）的输出是两个正交相关值（**I**n-phase 和 **Q**uadrature）：

$$I_n = A \cos(\Delta\phi_n)$$
$$Q_n = A \sin(\Delta\phi_n)$$

这个瞬时相位误差 $\Delta\phi_n$ 可以通过反正切函数计算出来：

$$\Delta\phi_n = \arctan\left(\frac{Q_n}{I_n}\right)$$

**结论：**
FLL 并不直接控制相位，但它**必须先鉴相**，才能计算出连续相位误差之间的差值，进而计算出频率误差。**（鉴相是原料生产线）**

---

### 2. 为什么 FLL 依然是“频率”环路？

尽管 FLL 内部使用了鉴相信息，但它的**控制律和最终目标**是频率，而不是相位。

| 环节 | FLL (频率环) | PLL (相位环) |
| :--- | :--- | :--- |
| **误差信号** | 相位差的**变化率** ($\frac{\Delta \phi[n] - \Delta \phi[n-1]}{T_{coh}}$) | 相位差的**绝对值** ($\Delta \phi[n]$) |
| **控制器输入**| 频率误差 | 相位误差 |
| **控制器功能**| 对频率误差**积分**，生成频率控制量。 | 对相位误差**积分**，生成相位/频率控制量。 |
| **控制目标** | 消除频率误差 $\Delta f$ | 消除相位误差 $\Delta \phi$ |

**简而言之：**

* FLL 拿到鉴相器的输出 $\Delta\phi$，然后对它进行**微分（差分）**，得到**频率误差**，用这个频率误差来控制本地振荡器的**频率**。
* PLL 拿到鉴相器的输出 $\Delta\phi$，直接用这个**相位误差**来控制本地振荡器的**相位**（或频率）。

因此，鉴相功能是一个**共用模块**，而对这个模块输出进行**不同的数学处理**（是否进行差分）和**不同的控制策略**（控制频率还是相位），才是区分 FLL 和 PLL 的根本所在。**（虽然用一样的工具，但切菜和切肉是两种不同的手艺。）**




## 锁相环（PLL）的工程实现细节

在现代集成电路（IC）设计中，**电荷泵锁相环（Charge-Pump PLL, CPPLL）**是最主流的实现方式，尤其用于**频率合成器**（Frequency Synthesizers）和**时钟发生器**。

### 1. 鉴相鉴频器（PFD）和电荷泵（CP）

* **PFD 实现：** PFD 通常由**两个 D 触发器**和一个 **AND 门**（用于复位）构成。它的核心优势是同时比较频率和相位，确保锁定范围广且无死区。
* **电荷泵 (CP) 实现：** CP 是由精确匹配的**电流源**和 **MOSFET 开关**构成的。它将 PFD 输出的 UP/DOWN 脉冲转换为电流脉冲 $I_{\text{up}}$ 或 $I_{\text{down}}$。
    * **关键设计挑战：** 必须确保 $I_{\text{up}}$ 和 $I_{\text{down}}$ 的电流大小严格匹配，否则会导致**电流失配**，从而产生**杂散信号**（Spurs）和**静相误差**（Static Phase Error）。

### 2. 环路滤波器（Loop Filter, LF）

* **功能：** LF 是一个**低通滤波器**，用于：
    1.  将 CP 输出的电流脉冲积分成平滑的 **DC 控制电压** $V_{\text{cont}}$。
    2.  抑制高频杂散信号（如参考频率 $F_{\text{ref}}$ 及其谐波）。
    3.  决定 PLL 的**动态特性**（如锁定时间、稳定性、带宽）。
* **常见类型：** 工程中最常用的是**二阶无源或有源滤波器**，它们提供一个零点和一个或多个极点，以确保系统在 $s$ 域中稳定且具有良好的阻尼比（通常 $\zeta \approx 0.707$）。

### 3. 压控振荡器（VCO）

* **功能：** 根据 $V_{\text{cont}}$ 线性调整输出频率 $F_{\text{out}}$。
* **高频实现：** 在射频（RF）应用中，VCO 通常采用**电感-电容（LC）谐振腔**或**环形振荡器（Ring Oscillator）**。
    * **LC-VCO：** **相位噪声**性能极佳，适用于通信系统。通过改变**变容二极管（Varactor）**上的电压来改变谐振频率。
    * **Ring VCO：** 结构简单，集成度高，但相位噪声稍差，常用于数字电路中的**时钟生成**。

### 4. 反馈分频器（Frequency Divider）

* **功能：** 将 VCO 输出频率 $F_{\text{out}}$ 除以整数 $N$（或分数 $N$），生成反馈信号 $F_{\text{feedback}} = F_{\text{out}}/N$。
* **频率合成器：** 通过改变 $N$ 的值，PLL 可以实现**频率合成**：
    $$F_{\text{out}} = N \cdot F_{\text{ref}}$$
    * **整数 N PLL：** $N$ 是整数。
    * **分数 N PLL：** $N$ 是分数，通过**调制分频比**（例如使用 $\Sigma\Delta$ 调制器）来实现更精细的频率步进，但会引入额外的**量化噪声**。

---

## 锁频环（FLL）的工程实现细节

FLL 在高动态环境（如全球导航卫星系统 $\text{GNSS}$ 接收机、弱信号跟踪）中更为常见，尤其在**全数字实现**中具有优势。

### 1. 鉴频器（Frequency Error Detector, FED）

FLL 的核心是鉴频器，它可以完全采用数字信号处理（DSP）技术实现：

* **数字鉴频器：** 通常基于**相位微分**原理。在数字域中，频率是相位的变化率 ($\omega = d\phi/dt$)。
    1.  **相位提取：** 使用反正切函数（$\text{atan2}$）从输入信号的同相分量 $I$ 和正交分量 $Q$ 中提取**瞬时相位** $\phi[n]$。
    2.  **频率误差计算：** 通过计算相邻采样点的相位差 $\Delta\phi[n] = \phi[n] - \phi[n-1]$ 来估算**瞬时频率**，并将其与参考频率进行比较，得到频率误差 $e_F[n]$。

#### 鉴频器工作机理总结

在现代数字接收机中，鉴频器（Frequency Detector, FD）的工作机理是**测量相位的变化速度**来间接测量频率差。

##### 核心原理：频率是相位的微分

$$\Delta f = f_{in} - f_{VCO} \propto \frac{d(\Delta \phi)}{dt}$$

即：频率差 $\Delta f$ 与输入信号和本地信号之间的**相位差 $\Delta \phi$ 随时间 $t$ 的变化率**成正比。

##### 鉴频器的三个关键步骤（以二象限反正切法为例）

鉴频器通过以下步骤将连续的信号转化为离散的频率误差值：

| 步骤 | 操作（数字域） | 目的 |
| :--- | :--- | :--- |
| **1. 正交解调** | 将输入信号 $S_{in}$ 分别与本地 $\cos$ 信号（$I$ 路）和 $\sin$ 信号（$Q$ 路）相乘，并滤除高频分量。 | 将信号从高频中频（IF）降至基带，并分离出瞬时相位信息 $I_k$ 和 $Q_k$。|
| **2. 瞬时相位测量** | 在采样时刻 $t_k$，计算本地信号与输入信号之间的瞬时相位误差 $\mathbf{\phi_{err, k}} = \mathbf{\text{atan2}(Q_k, I_k)}$。 | 确定在当前时刻，$S_{in}$ 相对于 $S_{VCO}$ “领先”或“落后”了多少角度。|
| **3. 计算相位变化率** | 测量两个相邻时刻 $t_k$ 和 $t_{k-1}$ 之间的**相位变化量** $\Delta \phi = \phi_{err, k} - \phi_{err, k-1}$。 | **这是关键一步。** $\Delta \phi$ 的大小和符号反映了 $f_{in}$ 和 $f_{VCO}$ 的频率差。|
| **4. 产生误差信号** | 频率误差 $\mathbf{V_{error}} \propto \frac{\Delta \phi}{\Delta t}$ | 将相位漂移的速度（频率差）转化为控制电压，用于调整 $S_{VCO}$ 的频率。|

##### 简化总结

鉴频器不是直接测量频率，而是通过**连续测量相位误差的角度 $\Delta \phi$**，然后计算出这个角度**变化的速度**（$\Delta \phi / \Delta t$），从而间接得到了输入和本地信号之间的频率差 $\Delta f$。当 $\Delta f = 0$ 时，相位差 $\Delta \phi$ 停止累积，系统进入**频率锁定**状态。

### 2. 数字环路滤波器（Digital Loop Filter, DLF）

* **实现：** FLL 环路滤波器通常使用**数字滤波器**（如 $\text{IIR}$ 或 $\text{PID}$ 控制器）在 $\text{FPGA}$ 或 $\text{DSP}$ 中实现。
* **作用：** 对频率误差 $e_F[n]$ 进行积分和滤波，生成数字控制字 $V_{\text{cont}}[n]$。

### 3. 数字压控振荡器（Numerically Controlled Oscillator, NCO）

* **功能：** $V_{\text{cont}}[n]$ 直接控制 $\text{NCO}$ 的**频率控制字**。$\text{NCO}$ 在数字域生成输出信号的相位和频率。
* **工作原理：** $\text{NCO}$ 使用**累加器**（Accumulator）来模拟振荡，每个时钟周期增加一个由控制字决定的步长，其输出的频率正比于这个步长。

---

## FLL 和 PLL 的联合工程（F-PLL）

在通信接收机中，FLL 和 PLL 经常**联合工作**（F-PLL），以达到最佳性能：

| 模式 | 目标 | 切换条件 | 优势 |
| :--- | :--- | :--- | :--- |
| **FLL 模式** | **快速捕获频率** | 系统启动时，或在**失锁**（Loss of Lock）后，频率偏差较大。 | 牵引范围大，锁定速度快，用于**粗调**。 |
| **PLL 模式** | **精确跟踪相位** | FLL 使频率误差降至一个可接受的**阈值**以下。 | **稳态误差极小**，相位噪声和抖动低，用于**精调**。 |

**工程实现：** 这通常通过在数字域设计一个**模式选择逻辑**和**切换门限**来实现。控制电压 $V_{\text{cont}}$ 可能是两个环路（FLL 和 PLL）控制信号的**融合**或**选择性输出**。

总而言之，**PLL** 主导了**时钟和频率合成**，以其极低的相位噪声和高精度著称，但需要精心设计模拟电路（如 $\text{CP}$ 和 $\text{VCO}$）。而 **FLL** 则在**快速捕获**和**数字通信**领域更具优势，且通常在 $\text{DSP}$ 或 $\text{FPGA}$ 中以全数字方式实现。